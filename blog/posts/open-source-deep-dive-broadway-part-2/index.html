<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.1827142f4f9e55776325.css" id="gatsby-global-css">code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}*{margin:0;padding:0}h1,h2,h3,h4,h5,h6{position:relative;font-family:var(--heading-font);margin:1em 0;font-weight:700}.anchor.before{fill:var(--fg-color)}body{--link-color:#ff5964;--bg-color:#fdfffc;--fg-color:#2b2d42;--base-unit:16px;--dark-text:#141414;--heading-font:"Open Sans","Open Sans","Montserrat",sans-serif;--body-font:"Open Sans",Avenir,Helvetica,Arial,sans-serif;--gray:#90a4ae;--shadow:#d7d7d7 5px 5px 10px;--pagination-background:#fafafa;--pagination-active-background:#f5f5f5;--blur:5px;background-color:var(--bg-color);color:var(--fg-color);font-size:var(--base-unit);font-family:var(--body-font);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;transition:background-color .5s}body.dark{--link-color:#83bcff;--bg-color:#2b2d42;--fg-color:#fdfffc;--gray:#90a4ae;--shadow:#000 5px 5px 10px;--pagination-background:#212121;--pagination-active-background:#424242;--blur:0px}p{line-height:25px;margin-bottom:1.5em}a{color:var(--link-color);font-weight:700;text-decoration:none}li a,p a{background:linear-gradient(180deg,var(--link-color) 0,var(--link-color)) repeat-x 0 100%;background-size:4px 2px;transition:all .3s}li a:hover,p a:hover{background-size:4px 50px;color:var(--fg-color)}ol,ul{margin-bottom:2em;margin-left:5%}ol li:not(:last-child),ul li:not(:last-child){margin-bottom:.5em}blockquote{position:relative;display:block;color:var(--gray);margin-bottom:2rem;padding:.5rem 0 .5rem 5%;font-size:1.5rem;border-left:5px solid var(--link-color)}blockquote p:last-child{padding:0;margin:0}blockquote p{line-height:2rem}.video-container{position:relative;width:100%;height:0;padding-bottom:56.25%;margin-bottom:1.5625rem}.video{position:absolute;top:0;left:0;width:100%;height:100%}code[class*=language-],pre[class*=language-]{font-family:Source Code Pro,monospace}:not(pre)>code[class*=language-]{background:none;color:var(--fg-color)}hr{margin:2em auto;border:none;border-top:3px dotted var(--gray);width:15%}@media screen and (max-width:1024px){body{--base-unit:15px}p{line-height:22px}}@media screen and (max-width:768px){body{--base-unit:14px}p{line-height:20px}blockquote{width:90%;margin:0 auto 2em}}@media screen and (max-width:512px){body{--base-unit:13px}p{line-height:18px}}.Layout-module--layout--2VhD0{margin:3rem auto;max-width:900px}header{display:flex;align-items:center;justify-items:center;justify-content:space-between}header h3{margin:0;padding:0;color:var(--fg-color)}header nav{align-self:end;justify-self:end}header nav a:not(:last-child){margin-right:15px}.Layout-module--title--29Uaf{align-items:center}.Layout-module--title--29Uaf,footer>div{display:flex;justify-content:space-between}footer>div{width:100%}.Layout-module--site-description--1flSc{flex-basis:1;min-width:30%}.Layout-module--site-description--1flSc p{margin:0;padding:0}.Layout-module--footer-links--3kCkY{width:100%;flex-basis:1;display:flex}.Layout-module--footer-title--17YbO{font-weight:700;padding:0;margin:0 0 15px}.Layout-module--page-navigation--1a6eH a,.Layout-module--social-media--293qT a{display:block;margin-bottom:5px}.Layout-module--page-navigation--1a6eH,.Layout-module--social-media--293qT{flex-basis:1;min-width:50%}.Layout-module--page-navigation--1a6eH a,.Layout-module--social-media--293qT a{font-weight:400}.Layout-module--social-media--293qT a{display:flex;align-items:center}.Layout-module--social-media--293qT svg{margin-right:5px;width:1.5em;height:1.5em}@media screen and (max-width:1024px){.Layout-module--layout--2VhD0{max-width:700px}}@media screen and (max-width:768px){.Layout-module--layout--2VhD0{max-width:500px}header{align-items:center;justify-content:center}footer>div,header{flex-direction:column}footer div{margin-bottom:20px}header nav{align-self:center;justify-self:center;margin-top:15px}}@media screen and (max-width:512px){.Layout-module--layout--2VhD0{max-width:420px}}@media screen and (max-width:420px){.Layout-module--layout--2VhD0{max-width:380px}}@media screen and (max-width:380px){.Layout-module--layout--2VhD0{max-width:300px}}.BackToTop-module--arrow--al5Ui{position:fixed;bottom:0;right:0;display:inline-flex;border-radius:3px;padding:5px 15px 15px 5px}.BackToTop-module--arrow--al5Ui:hover{cursor:pointer}.BackToTop-module--hidden--Gjp_L{visibility:collapse}@media screen and (max-width:768px){.BackToTop-module--arrow--al5Ui{visibility:collapse}}.index-module--home-container--3_ts4{height:100%;margin:3em auto;max-width:1024px}.index-module--main-container--2Cpru{display:flex;justify-content:space-between}.index-module--main-container--2Cpru .index-module--left--2pFCl{flex-basis:1;width:24%;text-align:right}.index-module--main-container--2Cpru .index-module--left--2pFCl img{border-radius:10px;margin-bottom:1em;width:100%}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--name--1rUFQ h1,.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--name--1rUFQ h2{margin:0;padding:0}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--name--1rUFQ h1{font-weight:400}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--name--1rUFQ h2{color:var(--gray)}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--links--iEcqI{margin-top:1em;margin-bottom:1em}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--links--iEcqI a{display:block;font-weight:400}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--links--iEcqI a:not(:last-child){margin-bottom:.3em}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--contact--4CEgV a{display:flex;justify-content:right;align-items:flex-end;flex-direction:row-reverse;font-weight:400}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--contact--4CEgV a:not(:last-child){margin-bottom:.3em}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--contact--4CEgV strong,.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--links--iEcqI strong{display:block;margin-bottom:1em}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--contact--4CEgV svg{width:1.5em;height:1.5em;margin-left:.5em}.index-module--main-container--2Cpru .index-module--right--31ZQq h1{margin-top:0}.index-module--main-container--2Cpru .index-module--right--31ZQq{flex-basis:2;width:72%}.index-module--main-container--2Cpru .index-module--right--31ZQq .index-module--recent--6-oDk h1{color:var(--fg-color)}.index-module--main-container--2Cpru .index-module--right--31ZQq .index-module--recent--6-oDk .index-module--subtitle--fCNrr{font-weight:400;margin:0 0 .5em}.index-module--main-container--2Cpru .index-module--right--31ZQq .index-module--recent--6-oDk h2{color:var(--gray);margin:0 0 .3em;font-weight:400}.index-module--main-container--2Cpru .index-module--right--31ZQq .index-module--recent--6-oDk .index-module--recent-box--3TVpN:not(:last-child){margin-bottom:2.5em}.index-module--main-container--2Cpru .index-module--right--31ZQq .index-module--recent--6-oDk .index-module--view-all--2BXoX{display:block;margin-bottom:1.2em}@media screen and (max-width:1024px){.index-module--home-container--3_ts4{max-width:950px}}@media screen and (max-width:950px){.index-module--home-container--3_ts4{max-width:768px}.index-module--main-container--2Cpru{flex-direction:column}.index-module--main-container--2Cpru .index-module--left--2pFCl,.index-module--main-container--2Cpru .index-module--right--31ZQq{width:100%}.index-module--main-container--2Cpru .index-module--left--2pFCl{text-align:center;margin-bottom:2em}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--contact--4CEgV a span{display:none}.index-module--main-container--2Cpru .index-module--left--2pFCl img{width:20%;height:20%}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--contact--4CEgV a,.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--links--iEcqI a{display:inline-block}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--links--iEcqI a:not(:last-child){margin-right:1em}.index-module--main-container--2Cpru .index-module--left--2pFCl .index-module--contact--4CEgV svg{width:3em;height:3em;margin:0 .5em 0 0}}@media screen and (max-width:768px){.index-module--home-container--3_ts4{max-width:500px}}@media screen and (max-width:512px){.index-module--home-container--3_ts4{max-width:400px}.index-module--contact--4CEgV,.index-module--links--iEcqI{flex-direction:column}.index-module--links--iEcqI{margin-bottom:15px}}@media screen and (max-width:420px){.index-module--home-container--3_ts4{max-width:300px}}.ThemeToggle-module--theme-toggle--34Hcp:hover{cursor:pointer}.QuickLink-module--link--1Fi1v{display:flex;justify-content:space-between;align-items:center;margin-bottom:1em;padding-left:1em;border-left:5px solid var(--link-color)}.QuickLink-module--link--1Fi1v h1{margin:0 0 .3em}.QuickLink-module--link--1Fi1v p{color:var(--gray);font-weight:400;margin:0;padding:0}.QuickLink-module--link--1Fi1v svg{width:2em;height:2em}.BlogList-module--general-title--1Y5KN{display:flex;justify-content:space-between;align-items:center}.BlogList-module--blog-card--5eORV a h2{margin:0;padding:0}.BlogList-module--blog-card--5eORV a{text-decoration:none}.BlogList-module--subtitle--31tcs{display:flex;justify-content:space-between}.BlogList-module--subtitle--31tcs h3{margin:1em 0;color:var(--gray);padding:0}.BlogList-module--tags--V3F-d{display:flex;flex-wrap:wrap}.BlogList-module--tags--V3F-d div{display:flex;padding:5px 10px;background-color:#e0f2f1;border-radius:5px;align-items:center;justify-content:center;margin-bottom:15px}.BlogList-module--tags--V3F-d div span{color:#424242}.BlogList-module--tags--V3F-d div svg{margin-right:5px}.BlogList-module--tags--V3F-d div:not(:last-child){margin-right:10px}.BlogPost-module--subtitle--1HkH3{margin-top:0;color:var(--gray)}.BlogPost-module--tags--UKQIN h4{display:flex;flex-wrap:wrap;margin-bottom:10px}.BlogPost-module--tags--UKQIN h4 svg{margin-right:15px}.BlogPost-module--tags-container--3jH5S{display:flex;flex-wrap:wrap}.BlogPost-module--tags--UKQIN span{padding:5px 10px;background-color:#5bc0be;color:var(--fg-color);border-radius:5px;margin-bottom:10px}.BlogPost-module--tags--UKQIN span:not(:last-child){margin-right:10px}.ProjectList-module--project-title--FhBjo{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.ProjectList-module--project-title--FhBjo h2{margin:0}.ProjectList-module--language--3j0Um,.ProjectList-module--status--2_mCI{border-radius:3px;padding:5px}.ProjectList-module--language--3j0Um{background-color:rgba(181,144,202,.4)}span.ProjectList-module--language--3j0Um{margin-right:15px}.ProjectList-module--description--269OJ{margin-bottom:15px}@media screen and (max-width:420px){.ProjectList-module--project-title--FhBjo{flex-direction:column;align-items:start}.ProjectList-module--project-title--FhBjo h2{margin-bottom:15px}}.PostListPagination-module--paginator--Z-Qcn{margin-top:15px;display:flex;justify-content:center}.PostListPagination-module--active-page--JPamV{background-color:var(--pagination-active-background)}.PostListPagination-module--paginator--Z-Qcn div{display:flex;flex-direction:row;align-content:center;align-items:center;justify-content:center}.PostListPagination-module--page-number--2IwV2{display:inline-flex;padding:3px 10px;border:1px solid #e0e0e0}.PostListPagination-module--page-number--2IwV2:hover{background-color:var(--pagination-background)}.ProjectListing-module--content--1I5Y- h2,.ProjectListing-module--content--1I5Y- h3{margin-top:0}.ProjectListing-module--links--1GSzL{display:flex;flex-direction:column;margin-bottom:15px}.ProjectListing-module--links--1GSzL a:not(:last-child){margin-bottom:15px}.ProjectListing-module--content--1I5Y-{display:flex;justify-content:space-between}.ProjectListing-module--sidebar--1lbQ1{flex-basis:30%}.ProjectListing-module--main-content--2LECC{flex-basis:60%}@media screen and (max-width:512px){.ProjectListing-module--content--1I5Y-{flex-direction:column}}.ImageCarousel-module--carousel-container--ZKRFj{position:relative;box-shadow:var(--shadow);margin-bottom:30px}.ImageCarousel-module--carousel--36424{position:relative}.ImageCarousel-module--background-image--cX-Ah{position:absolute;height:500px;top:0;width:100%;overflow:hidden;filter:blur(var(--blur))}.ImageCarousel-module--foreground-image--3vis1{display:flex;justify-content:center}.ImageCarousel-module--navigation-container--kiX9c{position:absolute;top:0;bottom:0;left:0;right:0;display:flex;align-items:center;justify-content:center}.ImageCarousel-module--navigation--29rLR{width:100%;display:flex;justify-content:space-between}.ImageCarousel-module--navigation--29rLR div{padding:15px}.ImageCarousel-module--navigation--29rLR div:hover{cursor:pointer}@media screen and (max-width:768px){.ImageCarousel-module--background-image--cX-Ah,.ImageCarousel-module--carousel-container--ZKRFj,.ImageCarousel-module--foreground-image--3vis1,.ImageCarousel-module--foreground-image--3vis1 img{max-height:300px;max-height:200px}}.PostNavigation-module--navigation--1UueV .PostNavigation-module--buttons--36jEH{display:flex;justify-content:space-between}.PostNavigation-module--navigation--1UueV .PostNavigation-module--buttons--36jEH p{display:flex;max-width:450px;border-radius:5px;margin-bottom:0}.PostNavigation-module--navigation--1UueV .PostNavigation-module--buttons--36jEH p a{display:flex;align-items:center;color:var(--textTitle);background:none}@media screen and (max-width:768px){.PostNavigation-module--navigation--1UueV .PostNavigation-module--buttons--36jEH{flex-direction:column}.PostNavigation-module--navigation--1UueV .PostNavigation-module--buttons--36jEH p:first-child{margin-bottom:15px;align-self:flex-start}.PostNavigation-module--navigation--1UueV .PostNavigation-module--buttons--36jEH p:last-child{align-self:flex-end}}</style><meta name="generator" content="Gatsby 3.3.0"/><title data-react-helmet="true">Open-source Deep Dive: Broadway (Part 2) - Inner workings of Broadway | A Programmer&#x27;s Perspective</title><meta data-react-helmet="true" name="description" content="12 April 2021 - Open-source Deep Dive: Broadway (Part 2) - Inner workings of Broadway - In this installment of Open-source Deep Dive, Broadway takes center stage! In part one, I uncover the mystery of message queues and concurrency in Elixir &amp; demystify the intricate design behind the pipelines that Broadway creates. In part two, I inspect how certain key features of Broadway work like rate limiting and batching! This is the second part of this two-part article! Note that this post is purely for educational purposes, the information gathered from here should only be used in the context of integration testing for websites that are directly under your ownership."/><meta data-react-helmet="true" name="image" content="https://woojiahao.github.io/images/icon.png"/><meta data-react-helmet="true" property="keywords" content="Open-source Deep Dive, Elixir, Broadway, data processing, message queue, message queues, concurrency, actor concurrency model, producer/consumer model, open-source, open-source project"/><meta data-react-helmet="true" property="og:url" content="https://woojiahao.github.io/blog/posts/open-source-deep-dive-broadway-part-2"/><meta data-react-helmet="true" property="og:title" content="Open-source Deep Dive: Broadway (Part 2) - Inner workings of Broadway | A Programmer&#x27;s Perspective"/><meta data-react-helmet="true" property="og:description" content="12 April 2021 - Open-source Deep Dive: Broadway (Part 2) - Inner workings of Broadway - In this installment of Open-source Deep Dive, Broadway takes center stage! In part one, I uncover the mystery of message queues and concurrency in Elixir &amp; demystify the intricate design behind the pipelines that Broadway creates. In part two, I inspect how certain key features of Broadway work like rate limiting and batching! This is the second part of this two-part article! Note that this post is purely for educational purposes, the information gathered from here should only be used in the context of integration testing for websites that are directly under your ownership."/><meta data-react-helmet="true" property="og:image" content="https://woojiahao.github.io/images/icon.png"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Open+Sans" rel="stylesheet"/><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="icon" href="/favicon-32x32.png?v=fd6bdb13db7426fe1da41411ded1b516" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=fd6bdb13db7426fe1da41411ded1b516"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=fd6bdb13db7426fe1da41411ded1b516"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=fd6bdb13db7426fe1da41411ded1b516"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=fd6bdb13db7426fe1da41411ded1b516"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=fd6bdb13db7426fe1da41411ded1b516"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=fd6bdb13db7426fe1da41411ded1b516"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=fd6bdb13db7426fe1da41411ded1b516"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=fd6bdb13db7426fe1da41411ded1b516"/><link rel="alternate" type="application/rss+xml" title="A Programmer&#x27;s Perspective RSS Feed" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-9d6d8fbb38c670d0db17.js"/><link as="script" rel="preload" href="/framework-7ff507bf526aae82f6c3.js"/><link as="script" rel="preload" href="/app-4a9d307f2885b4f64f6e.js"/><link as="script" rel="preload" href="/d0447323-dbe848dbbde40afbc849.js"/><link as="script" rel="preload" href="/1bfc9850-f060242a6c1c3ec3bbdf.js"/><link as="script" rel="preload" href="/d7eeaac4-197509e568d5f7b31992.js"/><link as="script" rel="preload" href="/0c428ae2-0daca1561ab49c58bacf.js"/><link as="script" rel="preload" href="/252f366e-0874e02fa63f9a6c7f8a.js"/><link as="script" rel="preload" href="/95b64a6e-e6f59033fe861f7df6b7.js"/><link as="script" rel="preload" href="/5e2a4920-d58c882e2d65d1e647e3.js"/><link as="script" rel="preload" href="/9f543f25a70c8f21fd0b844d715a43e0aaffa939-4470a7232cdc07660afe.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-blog-post-js-f267812a355f85283a5c.js"/><link as="fetch" rel="preload" href="/page-data/blog/posts/open-source-deep-dive-broadway-part-2/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2068778362.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2207116114.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>
void function() {
  window.__onThemeChange = function() {}

  var preferredTheme
  try {
    preferredTheme = localStorage.getItem('theme')
  } catch (err) { }

  function setTheme(newTheme) {
    if (preferredTheme && document.body.classList.contains(preferredTheme)) {
      document.body.classList.replace(preferredTheme, newTheme)
    } else {
      document.body.classList.add(newTheme)
    }

    window.__theme = newTheme
    preferredTheme = newTheme
    window.__onThemeChange(newTheme)
  }

  window.__setPreferredTheme = function(newTheme) {
    setTheme(newTheme)
    try {
      localStorage.setItem('theme', newTheme)
    } catch (err) {}
  }

  var darkQuery = window.matchMedia('(prefers-color-scheme: dark)')
  darkQuery.addListener(function(e) {
    window.__setPreferredTheme(e.matches ? 'dark' : 'light')
  })

  setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'))
}()
    </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><div class="Layout-module--layout--2VhD0"><label style="position:fixed;right:0;top:0;margin:15px"><input type="checkbox" hidden=""/> <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" class="ThemeToggle-module--theme-toggle--34Hcp" height="1.25em" width="1.25em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M14.53 10.53a7 7 0 01-9.058-9.058A7.003 7.003 0 008 15a7.002 7.002 0 006.53-4.47z" clip-rule="evenodd"></path></svg></label><header><a href="/"><h3>A Programmer&#x27;s Perspective</h3></a><nav><a href="/blog">Blog</a><a href="/projects">Projects</a><a href="/about">About Me</a><a href="https://www.notion.so/woojiahao/48b21a97d71c4cd2bc9a9051bd7423a3?v=e2c493015ceb47cfa275a03f20895cb1">Recommendations</a></nav></header><div class="Layout-module--title--29Uaf"><h1>Open-source Deep Dive: Broadway (Part 2) - Inner workings of Broadway</h1></div><div style="margin-bottom:2em"><div><h4 class="BlogPost-module--subtitle--1HkH3">Published on: <!-- -->12 April 2021</h4><div><p>This open-source deep dive has been split into two parts! The first part covers the prerequisite knowledge that would be good to know when trying to understand the inner workings of Broadway. The second part is an in-depth analysis of the implementation of various features of Broadway.</p>
<p>This is the second part of the deep dive and the following topics will be covered:</p>
<ol>
<li>Rate limiting</li>
<li>Batching messages</li>
<li>Telemetry</li>
<li>Creating a built-in testing support for pipelines</li>
<li>Achieving graceful shutdowns</li>
<li>Other interesting bits of code</li>
</ol>
<p>If you want a refresher on the concepts behind Broadway (like message queues and concurrency in Elixir) or to better understand Broadway's pipeline architecture from a bird's eye view, you can find the first part <a href="open-source-deep-dive-broadway-part-1">here!</a></p>
<h1 id="whats-the-scoop" style="position:relative;"><a href="#whats-the-scoop" aria-label="whats the scoop permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What's the scoop?</h1>
<p>Now that we have explored the overall architecture of a Broadway pipeline, we can look at how certain features in Broadway are implemented.</p>
<h2 id="rate-limiting" style="position:relative;"><a href="#rate-limiting" aria-label="rate limiting permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Rate limiting</h2>
<blockquote>
<p>Rate limiting refers to the act of limiting the amount of data that can be requested or processed in a given period of time</p>
</blockquote>
<p>Rate limiting is applied across producers within a single pipeline to control the number of events emitted within a given period of time.</p>
<p>This is especially useful when the hardware of the machine running the pipeline is not able to keep up with processing large numbers of events demanded at a time — possibly due to a poorly configured pipeline.</p>
<p>Some producers do not leverage the rate limiting feature of Broadway. For instance, the <a href="https://github.com/dashbitco/broadway/blob/master/lib/broadway/topology/producer_stage.ex">RabbitMQ producer</a> creates an active listener, which means that event emission is not inhibited by the rate limiter. Instead, events are emitted the moment messages are published to the message queue (unless <a href="https://hexdocs.pm/broadway_rabbitmq/BroadwayRabbitMQ.Producer.html#module-back-pressure-and-prefetch_count">otherwise configured</a>).</p>
<p>But for the producers that <em>do</em> leverage the rate limiting — such as the <a href="https://github.com/dashbitco/broadway_sqs/blob/master/lib/broadway_sqs/producer.ex">Amazon SQS producer</a> — rate limiting is applied in two instances:</p>
<ol>
<li>
<p>When consumers make demands to the producer-consumer or producer</p>
<p>If the producer can still emit events, any demand made by the consumer will be handled by the producer. We take into account the rate limit threshold. If there are too many events to emit, the excess messages are stored in a message buffer that will have to be cleared later on.</p>
<p>Each message that can be emitted will be transformed into the standard event structure that Broadway uses.</p>
<p>If the producer can no longer emit messages, any demand made is stored in a demand buffer that is cleared later on.</p>
</li>
<li>
<p>When the rate limit is being reset after the given interval</p>
<p>After the given interval, the rate limit threshold can be reset. However, we may have accumulated demands and messages in their respective buffers. We may find that the threshold has not been met before we reset it. Thus, we can use this remaining threshold to clear any lingering demands and messages stored in their respective buffers.</p>
<p>Once we have cleared as many messages as our remaining threshold allows, we will reset the threshold and schedule for another reset. These resets are scheduled at fixed intervals.</p>
</li>
</ol>
<p>The rate limiting threshold is maintained as an <a href="https://erlang.org/doc/man/atomics.html">atomic</a> (discussed later on). This atomic array is generated by the <code class="language-text">RateLimiter</code> process. This module handles all behavior surrounding working with the rate limit threshold. <code class="language-text">ProducerStage</code> handles the actual logic of managing the demands of consumers.</p>
<p>When the producer cannot emit any more events, i.e. the threshold has been reached, an internal state is set to <code class="language-text">:closed</code> to avoid future demands from being handled.</p>
<h2 id="batching" style="position:relative;"><a href="#batching" aria-label="batching permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Batching</h2>
<p>Batching groups events based on given properties and sends them to designated "sub-pipelines" or batch processors to be handled. For instance, we might design a pipeline that stores events with even numbers in an S3 bucket and ones with odd numbers on Google Drive.</p>
<p>The <code class="language-text">Batcher</code> process is assigned unique names for identification and events that are emitted from the producer must be tagged to a batcher. Failure to do so will result in a runtime error. This only applies if batching is enabled.</p>
<p>In order for the producer to send the appropriate events to the respective batcher, a <code class="language-text">PartitionDispatcher</code> is used. Essentially, it defines the behavior of how events are emitted to consumers. A <code class="language-text">PartitionDispatcher</code> dispatches events to certain consumers based on a given criteria (defined as a <a href="https://en.wikipedia.org/wiki/Hash_function">hash function</a>). In this case, the criterion is the name of the batcher from the given event. This means that when we assign a batcher to the event, it <strong>will</strong> be dispatched to only that batcher. More information about dispatchers in GenStage can be found in the <a href="https://hexdocs.pm/gen_stage/GenStage.Dispatcher.html#summary">official documentation</a>.</p>
<p>Even within the batcher, further grouping can be made based on a batch key assigned to the event. This may be used to ensure that certain events are processed together. Internally, the batcher will accumulate events before emitting them. However, as it cannot sit around accumulating events forever, a batch is emitted at regular intervals regardless of how many events are stored in it.</p>
<p>The <code class="language-text">BatchProcessor</code> process handles a single batch at a time. It is similar to a regular processor, except it works on a batch of events. The <code class="language-text">handle_batch</code> callback is used here.</p>
<h2 id="telemetry" style="position:relative;"><a href="#telemetry" aria-label="telemetry permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Telemetry</h2>
<p>Telemetry is used in Broadway to benchmark certain operations that occur such as the duration that a <code class="language-text">handle_message</code> callback takes.</p>
<p>Broadway relies on the <code class="language-text">telemetry</code> <a href="https://hexdocs.pm/telemetry/">library</a>. Within the code, events are emitted when these operations occur and key measurements such as duration are tracked. Handlers/listeners of these events can be setup to respond to these events.</p>
<p>Telemetry is not an Elixir-only feature. It is commonly used to perform application monitoring. <a href="https://opentelemetry.io/">OpenTelemetry</a> is a really interesting framework that offers powerful application monitoring through telemetry.</p>
<h2 id="built-in-testing" style="position:relative;"><a href="#built-in-testing" aria-label="built in testing permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Built-in testing</h2>
<p>To test the pipeline, we should focus on ensuring that the data processing aspect of the pipeline works as intended. However, as we rely on external services for input, it would be hard to coordinate a test suite to work with a live data source as we may not be able to replicate the data source or publish data to the data source at will due to access limitations. Thus, Broadway has designed a testing utility that allows us to test the pipeline's data processing capacity without relying on the data source.</p>
<p>Broadway provides a placeholder producer module. This producer does not rely on any data sources. Instead, messages are emitted directly into the pipeline.</p>
<p>The producer module should be tested separately if there is core behavior that cannot be tested along with the pipeline.</p>
<p>This form of unit testing ensures that we reduce potential points of failure in our test suite if any of the aforementioned problems with using the original data source should surface.</p>
<h2 id="graceful-shutdowns" style="position:relative;"><a href="#graceful-shutdowns" aria-label="graceful shutdowns permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Graceful shutdowns</h2>
<p>Broadway boasts about having <a href="https://hexdocs.pm/broadway/architecture.html#graceful-shutdowns">graceful shutdowns</a>. This is a rather interesting concept to explore as it relies heavily on the concurrency system of Elixir.</p>
<p>Essentially, the pipeline can only exist in two states — when all components are online and when all components are shutting down. There is no point in time where a single component will shutdown on its own without being restarted. This is because of the way that the supervisor of each component declares restart strategies ensuring that should a child process encounters any errors, it will be restarted without a hitch. This way, the only time where our components can shut down is when we shut down our main process or pipeline supervisor process. When either process is terminated, we want to properly handle all remaining events in the pipeline before shutting off every component.</p>
<p>This is achieved through a mix of concurrency features. But before we can explain how it works, a simple introduction of exit signals and process termination is due.</p>
<h3 id="exit-signals-and-process-termination" style="position:relative;"><a href="#exit-signals-and-process-termination" aria-label="exit signals and process termination permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Exit signals and process termination</h3>
<p>Processes can be <a href="https://hexdocs.pm/elixir/Process.html#link/1">linked</a> to one another. When either process receives an exit signal — which can occur when the process is terminated forcibly or when it receives an exit signal propagated from its parent — it will propagate the exit signal to the linked process and that process will terminate as well.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 441px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/8511bca0d47fe5caa547e5214926194a/eed25/linking.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 48%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAEDAgX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB7yU4qYK//8QAGRAAAQUAAAAAAAAAAAAAAAAAAgAQMUFC/9oACAEBAAEFAqbJIY//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAVEQEBAAAAAAAAAAAAAAAAAAAQQf/aAAgBAgEBPwGn/8QAFhABAQEAAAAAAAAAAAAAAAAAADEg/9oACAEBAAY/AkTH/8QAHRAAAgEEAwAAAAAAAAAAAAAAAAEREDFhcYGx8f/aAAgBAQABPyHQc5cin0LoXLVP/9oADAMBAAIAAwAAABAYD//EABURAQEAAAAAAAAAAAAAAAAAABBB/9oACAEDAQE/EIf/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPxBj/8QAGhAAAgMBAQAAAAAAAAAAAAAAAAERITFxQf/aAAgBAQABPxBLMsyRYJpqLIiQ8dOAWeQrSrP/2Q=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Process linking"
        title="Process linking"
        src="/static/8511bca0d47fe5caa547e5214926194a/eed25/linking.jpg"
        srcset="/static/8511bca0d47fe5caa547e5214926194a/863e1/linking.jpg 225w,
/static/8511bca0d47fe5caa547e5214926194a/eed25/linking.jpg 441w"
        sizes="(max-width: 441px) 100vw, 441px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
      />
  </a>
    </span></p>
<p>However, these exit signals can be <a href="https://crypt.codemancers.com/posts/2016-01-24-understanding-exit-signals-in-erlang-slash-elixir/">trapped</a> instead. When this occurs, rather than terminating the process that receives the propagated exit signal, the exit signal is sent as a message, allowing the receiving process to handle the exit as though it was just another message.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token keyword">def</span> handle_info<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token atom symbol">:EXIT</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> reason<span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
	<span class="token comment"># ...</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>When a process is terminated, an optional <code class="language-text">terminate/2</code> <a href="https://hexdocs.pm/elixir/GenServer.html#c:terminate/2">callback</a> can be declared to perform any cleanup before the process is actually terminated. This is useful if we have any lingering operations that should be completed before we terminate the process.</p>
<p><a href="https://hexdocs.pm/elixir/Supervisor.html">Supervisors</a> can start a list of child processes and is responsible for managing the restart strategy of each child. The interaction between a supervisor and <code class="language-text">terminate</code> is rather interesting. When a child is terminated, it is restarted accordingly. When a supervisor terminates, all of its children will also be terminated. If a child process traps exits, the <code class="language-text">terminate</code> callback is called. If not, it will simply terminate immediately without calling the callback. More information about how supervisor interact with shutdowns can be found in the official <a href="https://hexdocs.pm/elixir/Supervisor.html#module-start-and-shutdown">documentation</a>.</p>
<h3 id="back-to-our-regularly-scheduled-deep-dive" style="position:relative;"><a href="#back-to-our-regularly-scheduled-deep-dive" aria-label="back to our regularly scheduled deep dive permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Back to our regularly scheduled deep dive...</h3>
<p>With a basic understanding of exit trapping and process termination, we can actually understand how graceful shutdowns in Broadway works.</p>
<p>When the main process or the pipeline supervisor process is terminated, the main process — which traps exit signals — will invoke its <code class="language-text">terminate</code> callback which will inform the <code class="language-text">Terminator</code> process to begin trapping exits and terminate our pipeline supervisor. As this <code class="language-text">Terminator</code> process is a child of the pipeline supervisor, it will invoke its implementation of <code class="language-text">terminate</code>.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> terminate<span class="token punctuation">(</span>reason<span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span><span class="token attr-name">name:</span> name<span class="token punctuation">,</span> <span class="token attr-name">supervisor_pid:</span> supervisor_pid<span class="token punctuation">,</span> <span class="token attr-name">terminator:</span> terminator<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  Broadway<span class="token punctuation">.</span>Topology<span class="token punctuation">.</span>Terminator<span class="token punctuation">.</span>trap_exit<span class="token punctuation">(</span>terminator<span class="token punctuation">)</span>
  ref <span class="token operator">=</span> Process<span class="token punctuation">.</span>monitor<span class="token punctuation">(</span>supervisor_pid<span class="token punctuation">)</span>
  Process<span class="token punctuation">.</span>exit<span class="token punctuation">(</span>supervisor_pid<span class="token punctuation">,</span> reason_to_signal<span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>

  receive <span class="token keyword">do</span>
    <span class="token punctuation">{</span><span class="token atom symbol">:DOWN</span><span class="token punctuation">,</span> <span class="token operator">^</span>ref<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">}</span> <span class="token operator">-></span> <span class="token atom symbol">:persistent_term</span><span class="token punctuation">.</span>erase<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token atom symbol">:ok</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The exit signal propagates to the other components through their supervisors terminating and they will also invoke their <code class="language-text">terminate</code> callback if they trap exits such as producers disconnecting from the data source.</p>
<p>The <code class="language-text">Terminator</code> process is responsible for ensuring that all events still within the pipeline are processed before terminating the pipeline entirely.</p>
<p>It does so in three phases:</p>
<ol>
<li>Notify that the processors do not resubscribe to producers through a state flag</li>
<li>Drain the producers of any events remaining by emitting the events through the pipeline</li>
<li>Wait for the batch processors (which will be the very last component in the pipeline) to terminate before terminating the supervisor</li>
</ol>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token attribute variable">@impl</span> <span class="token boolean">true</span>
<span class="token keyword">def</span> terminate<span class="token punctuation">(</span>_<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token keyword">for</span> name <span class="token operator">&lt;-</span> state<span class="token punctuation">.</span>first<span class="token punctuation">,</span> pid <span class="token operator">=</span> Process<span class="token punctuation">.</span>whereis<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">do</span>
    send<span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token atom symbol">:will_terminate</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">for</span> name <span class="token operator">&lt;-</span> state<span class="token punctuation">.</span>producers<span class="token punctuation">,</span> pid <span class="token operator">=</span> Process<span class="token punctuation">.</span>whereis<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">do</span>
    Broadway<span class="token punctuation">.</span>Topology<span class="token punctuation">.</span>ProducerStage<span class="token punctuation">.</span>drain<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
  <span class="token keyword">end</span>

  <span class="token keyword">for</span> name <span class="token operator">&lt;-</span> state<span class="token punctuation">.</span>last<span class="token punctuation">,</span> pid <span class="token operator">=</span> Process<span class="token punctuation">.</span>whereis<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">do</span>
    ref <span class="token operator">=</span> Process<span class="token punctuation">.</span>monitor<span class="token punctuation">(</span>pid<span class="token punctuation">)</span>

    receive <span class="token keyword">do</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:done</span><span class="token punctuation">,</span> <span class="token operator">^</span>pid<span class="token punctuation">}</span> <span class="token operator">-></span> <span class="token atom symbol">:ok</span>
      <span class="token punctuation">{</span><span class="token atom symbol">:DOWN</span><span class="token punctuation">,</span> <span class="token operator">^</span>ref<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">}</span> <span class="token operator">-></span> <span class="token atom symbol">:ok</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>

  <span class="token atom symbol">:ok</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Interestingly, as the producer may be waiting to drain events, we may not want to cancel all of its consumers immediately. Thus, we rely on <code class="language-text">GenStage#async_info</code> to <a href="https://hexdocs.pm/gen_stage/GenStage.html#async_info/2">queue</a> the message to cancel all consumers at the end of the GenStage message queue — effectively waiting for all other events to be processed before cancelling all consumers. If batching is enabled, the processors will also wait for the batches to be processed before cancelling all consumers.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token attribute variable">@spec</span> drain<span class="token punctuation">(</span>GenServer<span class="token punctuation">.</span>server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token atom symbol">:ok</span>
<span class="token keyword">def</span> drain<span class="token punctuation">(</span>producer<span class="token punctuation">)</span> <span class="token keyword">do</span>
  GenStage<span class="token punctuation">.</span>demand<span class="token punctuation">(</span>producer<span class="token punctuation">,</span> <span class="token atom symbol">:accumulate</span><span class="token punctuation">)</span>
  GenStage<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>producer<span class="token punctuation">,</span> <span class="token punctuation">{</span>__MODULE__<span class="token punctuation">,</span> <span class="token atom symbol">:prepare_for_draining</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token comment"># The :cancel_consumers message is added to the end of the message queue</span>
  GenStage<span class="token punctuation">.</span>async_info<span class="token punctuation">(</span>producer<span class="token punctuation">,</span> <span class="token punctuation">{</span>__MODULE__<span class="token punctuation">,</span> <span class="token atom symbol">:cancel_consumers</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>These mechanisms ensure that all events left in the pipeline is properly processed before the pipeline terminates, thus achieving graceful shutdowns.</p>
<h1 id="fascinating-discovery" style="position:relative;"><a href="#fascinating-discovery" aria-label="fascinating discovery permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fascinating discovery!</h1>
<p>These are some interesting bits of code that Broadway has.</p>
<h2 id="__using__-configurations" style="position:relative;"><a href="#__using__-configurations" aria-label="__using__ configurations permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">__using__</code> configurations</h2>
<p>Like other libraries in Elixir, <code class="language-text">use Broadway</code> is where it all begins. As discussed in the previous <a href="https://woojiahao.github.io/blog/posts/open-source-deep-dive-hound">open-source deep dive</a>, the behavior of <code class="language-text">use</code> can be altered by defining the <code class="language-text">__using__</code> macro.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir">defmacro __using__<span class="token punctuation">(</span>opts<span class="token punctuation">)</span> <span class="token keyword">do</span>
  quote <span class="token attr-name">location:</span> <span class="token atom symbol">:keep</span><span class="token punctuation">,</span> <span class="token attr-name">bind_quoted:</span> <span class="token punctuation">[</span><span class="token attr-name">opts:</span> opts<span class="token punctuation">,</span> <span class="token attr-name">module:</span> __CALLER__<span class="token punctuation">.</span>module<span class="token punctuation">]</span> <span class="token keyword">do</span>
    <span class="token attribute variable">@behaviour</span> Broadway

    <span class="token attribute variable">@doc</span> <span class="token boolean">false</span>
    <span class="token keyword">def</span> child_spec<span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token keyword">do</span>
      default <span class="token operator">=</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>
        <span class="token attr-name">id:</span> unquote<span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token attr-name">start:</span> <span class="token punctuation">{</span>__MODULE__<span class="token punctuation">,</span> <span class="token atom symbol">:start_link</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>arg<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token attr-name">shutdown:</span> <span class="token atom symbol">:infinity</span>
      <span class="token punctuation">}</span>

      Supervisor<span class="token punctuation">.</span>child_spec<span class="token punctuation">(</span>default<span class="token punctuation">,</span> unquote<span class="token punctuation">(</span>Macro<span class="token punctuation">.</span>escape<span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>

    defoverridable <span class="token attr-name">child_spec:</span> <span class="token number">1</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>There are three interesting bits of code in the <code class="language-text">__using__</code> macro:</p>
<ol>
<li>
<p><code class="language-text">location: keep</code></p>
<p>Used to report runtime errors from inside the quote. Without this, errors are reported where the defined function (in <code class="language-text">quote</code>) is invoked. This is to ensure that we are aware of where the errors are occurring. More information about this configuration can be found <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#quote/2-stacktrace-information">here</a>.</p>
</li>
<li>
<p><code class="language-text">bind_quoted</code></p>
<p>Used to create bindings within the quote. When a binding is created, the value is automatically <a href="https://elixir-lang.org/getting-started/meta/quote-and-unquote.html#unquoting">unquoted</a> (which includes evaluation) and the value cannot be unquoted again. This is especially used when we do not want to re-evaluate the value multiple times.</p>
<p>More information quoting and unquoting in Elixir can be found in the <a href="https://elixir-lang.org/getting-started/meta/quote-and-unquote.html">official tutorial</a> and a simplified explanation and example of binding can be found <a href="https://elixirschool.com/en/lessons/advanced/metaprogramming/#binding">here</a>.</p>
</li>
<li>
<p><code class="language-text">@behaviour</code></p>
<p>Used to define interface-like behavior where modules that adopt these behaviors can implement callbacks defined. In this case, when a module <code class="language-text">use Broadway</code>, it will have to implement certain callbacks like <code class="language-text">handle_message</code> while other callbacks like <code class="language-text">handle_batch</code> remain optional.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token attribute variable">@callback</span> prepare_messages<span class="token punctuation">(</span>messages <span class="token operator">::</span> <span class="token punctuation">[</span>Message<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> context <span class="token operator">::</span> term<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token punctuation">[</span>Message<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token attribute variable">@callback</span> handle_message<span class="token punctuation">(</span>processor <span class="token operator">::</span> atom<span class="token punctuation">,</span> message <span class="token operator">::</span> Message<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context <span class="token operator">::</span> term<span class="token punctuation">)</span> <span class="token operator">::</span>
            Message<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token attribute variable">@callback</span> handle_batch<span class="token punctuation">(</span>
            batcher <span class="token operator">::</span> atom<span class="token punctuation">,</span>
            messages <span class="token operator">::</span> <span class="token punctuation">[</span>Message<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            batch_info <span class="token operator">::</span> BatchInfo<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            context <span class="token operator">::</span> term
          <span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token punctuation">[</span>Message<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token attribute variable">@callback</span> handle_failed<span class="token punctuation">(</span>messages <span class="token operator">::</span> <span class="token punctuation">[</span>Message<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> context <span class="token operator">::</span> term<span class="token punctuation">)</span> <span class="token operator">::</span> <span class="token punctuation">[</span>Message<span class="token punctuation">.</span>t<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token attribute variable">@optional_callbacks</span> <span class="token attr-name">prepare_messages:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token attr-name">handle_batch:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token attr-name">handle_failed:</span> <span class="token number">2</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>More information about typespecs can be found in the <a href="https://elixir-lang.org/getting-started/typespecs-and-behaviours.html#adopting-behaviours">official documentation</a>.</p>
</li>
</ol>
<h2 id="module-metadata-processing" style="position:relative;"><a href="#module-metadata-processing" aria-label="module metadata processing permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Module metadata processing</h2>
<p>While on the topic of meta-programming, module metadata can also be processed.</p>
<p><code class="language-text">ensure_loaded?</code> ensures that a given module is loaded. In Broadway, this is used to ensure that the <code class="language-text">:persistent_term</code> module from Erlang is available for Elixir — the only time it will not be available is when the version of Elixir is too old. Documentation <a href="https://hexdocs.pm/elixir/Code.html#ensure_loaded?/1">here</a>.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token keyword">unless</span> Code<span class="token punctuation">.</span>ensure_loaded?<span class="token punctuation">(</span><span class="token atom symbol">:persistent_term</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token keyword">require</span> Logger
  Logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Broadway requires Erlang/OTP 21.3+"</span><span class="token punctuation">)</span>
  raise <span class="token string">"Broadway requires Erlang/OTP 21.3+"</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><code class="language-text">function_exported?</code> returns whether a module contains a definition for a <strong>public</strong> function with a given arity. Used to execute functions from modules if they are defined. Documentation <a href="https://hexdocs.pm/elixir/Kernel.html#function_exported?/3">here</a>.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token keyword">if</span> Code<span class="token punctuation">.</span>ensure_loaded?<span class="token punctuation">(</span>producer_mod<span class="token punctuation">)</span> <span class="token keyword">and</span>
     function_exported?<span class="token punctuation">(</span>producer_mod<span class="token punctuation">,</span> <span class="token atom symbol">:prepare_for_start</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token keyword">case</span> producer_mod<span class="token punctuation">.</span>prepare_for_start<span class="token punctuation">(</span>module<span class="token punctuation">,</span> opts<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token punctuation">{</span>child_specs<span class="token punctuation">,</span> opts<span class="token punctuation">}</span> <span class="token keyword">when</span> is_list<span class="token punctuation">(</span>child_specs<span class="token punctuation">)</span> <span class="token operator">-></span>
      <span class="token punctuation">{</span>child_specs<span class="token punctuation">,</span> NimbleOptions<span class="token punctuation">.</span>validate!<span class="token punctuation">(</span>opts<span class="token punctuation">,</span> Broadway<span class="token punctuation">.</span>Options<span class="token punctuation">.</span>definition<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

    other <span class="token operator">-></span>
			<span class="token comment"># ...</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2 id="dynamic-process-naming" style="position:relative;"><a href="#dynamic-process-naming" aria-label="dynamic process naming permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dynamic process naming</h2>
<p>As the pipeline can comprise of any number of components, Broadway supports dynamically generated processes. These dynamically generated processes are assigned names that follow a fixed convention — comprising of the name of the pipeline, the process type, and the index of the component among the other components of the same type.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token keyword">defp</span> process_name<span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> type<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token keyword">do</span>
  :<span class="token string">"<span class="token interpolation"><span class="token delimiter punctuation">#{</span>name_prefix<span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token delimiter punctuation">}</span></span>.<span class="token interpolation"><span class="token delimiter punctuation">#{</span>type<span class="token delimiter punctuation">}</span></span>_<span class="token interpolation"><span class="token delimiter punctuation">#{</span>index<span class="token delimiter punctuation">}</span></span>"</span>
<span class="token keyword">end</span>

<span class="token keyword">defp</span> process_names<span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> type<span class="token punctuation">,</span> config<span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token keyword">for</span> index <span class="token operator">&lt;-</span> <span class="token number">0</span><span class="token operator">..</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token atom symbol">:concurrency</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">do</span>
    process_name<span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> type<span class="token punctuation">,</span> index<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The names are returned as quoted atoms where the atom has a space in it so it has to be declared via <code class="language-text">:&quot;&quot;</code> .</p>
<h2 id="storage-options-in-elixir" style="position:relative;"><a href="#storage-options-in-elixir" aria-label="storage options in elixir permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Storage options in Elixir</h2>
<p>Besides the basic data structures like lists and dictionaries, Elixir and Erlang offer other ways of storing data within processes.</p>
<ol>
<li>
<p><a href="https://erlang.org/doc/man/atomics.html">Atomics</a></p>
<p><code class="language-text">:atomics</code> are a way of performing atomic operations on a set of mutable atomic variables.</p>
<p>Used to maintain the rate limiting threshold.</p>
<p>Previously, the rate limiter used <a href="https://erlang.org/doc/man/ets.html">ETS</a> instead but atomic operations are much better for concurrent systems as they avoid race conditions when multiple producer processes are attempting to modify the rate limit.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir">counter <span class="token operator">=</span> <span class="token atom symbol">:atomics</span><span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token attribute variable">@atomics_index</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token atom symbol">:atomics</span><span class="token punctuation">.</span>put<span class="token punctuation">(</span>counter<span class="token punctuation">,</span> <span class="token attribute variable">@atomics_index</span><span class="token punctuation">,</span> allowed<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
</li>
<li>
<p><a href="https://erlang.org/doc/man/persistent_term.html">Persistent term</a></p>
<p>Storage for Erlang terms that is optimised for reading terms at the expense of writing and updating terms.</p>
<p>Used to store pipeline metadata like producer names etc.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token atom symbol">:persistent_term</span><span class="token punctuation">.</span>put<span class="token punctuation">(</span>config<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token punctuation">%</span><span class="token punctuation">{</span>
  <span class="token attr-name">context:</span> config<span class="token punctuation">.</span>context<span class="token punctuation">,</span>
  <span class="token attr-name">producer_names:</span> process_names<span class="token punctuation">(</span>config<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"Producer"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>producer_config<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token attr-name">batchers_names:</span>
    Enum<span class="token punctuation">.</span>map<span class="token punctuation">(</span>config<span class="token punctuation">.</span>batchers_config<span class="token punctuation">,</span> <span class="token capture function">&amp;process_name</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">"Batcher"</span><span class="token punctuation">,</span> elem<span class="token punctuation">(</span><span class="token argument variable">&amp;1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token attr-name">rate_limiter_name:</span>
    config<span class="token punctuation">.</span>producer_config<span class="token punctuation">[</span><span class="token atom symbol">:rate_limiting</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> RateLimiter<span class="token punctuation">.</span>rate_limiter_name<span class="token punctuation">(</span>opts<span class="token punctuation">[</span><span class="token atom symbol">:name</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
</li>
<li>
<p><a href="https://erlang.org/doc/man/queue.html">Queue</a></p>
<p>Manage first-in, first-out queues.</p>
<p>Used to manage message and demand buffers in the producer.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token comment"># A queue of "batches" of messages that we buffered.</span>
<span class="token attr-name">message_buffer:</span> <span class="token atom symbol">:queue</span><span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token comment"># A queue of demands (integers) that we buffered.</span>
<span class="token attr-name">demand_buffer:</span> <span class="token atom symbol">:queue</span><span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
</li>
<li>
<p><a href="https://hexdocs.pm/elixir/Process.html">Process dictionaries</a></p>
<p>Store state within a process directly although its usage is generally <a href="https://elixirforum.com/t/is-it-a-good-idea-to-store-context-in-process-dictionary-registry-for-http-requests/3142">frowned upon</a>.</p>
<p>Used to store batches in the batcher.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir"><span class="token keyword">defp</span> init_or_get_batch<span class="token punctuation">(</span>batch_key<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword">do</span>
  <span class="token keyword">if</span> batch <span class="token operator">=</span> Process<span class="token punctuation">.</span>get<span class="token punctuation">(</span>batch_key<span class="token punctuation">)</span> <span class="token keyword">do</span>
    batch
  <span class="token keyword">else</span>
		<span class="token comment"># ...</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token keyword">defp</span> put_batch<span class="token punctuation">(</span>batch_key<span class="token punctuation">,</span> <span class="token punctuation">{</span>_<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _<span class="token punctuation">}</span> <span class="token operator">=</span> batch<span class="token punctuation">)</span> <span class="token keyword">do</span>
  Process<span class="token punctuation">.</span>put<span class="token punctuation">(</span>batch_key<span class="token punctuation">,</span> batch<span class="token punctuation">)</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>A better alternative might have been to use an <a href="https://hexdocs.pm/elixir/Agent.html">Agent</a> or ETS instead.</p>
<p><strong>Edit!</strong> I clarified with the team about their decision to use process dictionaries over ETS, this was their response:</p>
<blockquote>
<p>The correct solution here would be to simply use a map. But because this is very intensive code, we need a mutable option, and the process dictionary is the most efficient one. ETS would be slow as data has to be copied in and out of ETS.
This is one of the very cases where using the pdict for performance is justified. :)</p>
</blockquote>
<p>So, the reason why they decided to use a process dictionary over ETS is due to the performance requirement of batching! Very interesting!</p>
</li>
</ol>
<h2 id="options-validation" style="position:relative;"><a href="#options-validation" aria-label="options validation permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Options validation</h2>
<p>Dashbit — the team behind Broadway — developed an options validation library called <a href="https://github.com/dashbitco/nimble_options">NimbleOptions</a> that aims to be a small library for validating and documenting high-level options.</p>
<p>A set of definitions for the available options are created first and these can be used to validate a keyword list — aka the options.</p>
<p>If the options are invalid, an error is returned, otherwise an <code class="language-text">:ok</code> status along with the options are returned. The returned options have default values filled in.</p>
<h2 id="default-values-in-dictionaries" style="position:relative;"><a href="#default-values-in-dictionaries" aria-label="default values in dictionaries permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Default values in dictionaries</h2>
<p>Broadway has an interesting way of fanning out default values for the options keyword list. In the options keyword list, a "parent" value for <code class="language-text">:partition_by</code>, <code class="language-text">:hibernate_after</code>, and <code class="language-text">:spawn_opt</code> is provided.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir">options <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token attr-name">partition_by:</span> <span class="token operator">...</span><span class="token punctuation">,</span> <span class="token comment"># these are parent values</span>
	<span class="token attr-name">hibernate_after:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
	<span class="token attr-name">producer:</span> <span class="token punctuation">[</span>
		<span class="token attr-name">hibernate_after:</span> <span class="token operator">...</span> <span class="token comment"># this is a child value</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">]</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The parent value will be used for producers, processors, and batchers if no explicit child value is provided. Alternatively, we might want to fan out a parent value to only two of the three unset child values while maintaining the original child value of the third.</p>
<p>This is done by <a href="https://hexdocs.pm/elixir/Keyword.html#merge/2">merging</a> the child options into the parent options. Thus, if the child does not define a value for the option, the parent value is inherited.</p>
<div class="gatsby-highlight" data-language="elixir"><pre style="counter-reset: linenumber NaN" class="language-elixir line-numbers"><code class="language-elixir">opts <span class="token operator">=</span>
  opts
  <span class="token operator">|></span> carry_over_one<span class="token punctuation">(</span><span class="token atom symbol">:producer</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom symbol">:hibernate_after</span><span class="token punctuation">,</span> <span class="token atom symbol">:spawn_opt</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token operator">|></span> carry_over_many<span class="token punctuation">(</span><span class="token atom symbol">:processors</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom symbol">:partition_by</span><span class="token punctuation">,</span> <span class="token atom symbol">:hibernate_after</span><span class="token punctuation">,</span> <span class="token atom symbol">:spawn_opt</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token operator">|></span> carry_over_many<span class="token punctuation">(</span><span class="token atom symbol">:batchers</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token atom symbol">:partition_by</span><span class="token punctuation">,</span> <span class="token atom symbol">:hibernate_after</span><span class="token punctuation">,</span> <span class="token atom symbol">:spawn_opt</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">defp</span> carry_over_one<span class="token punctuation">(</span>opts<span class="token punctuation">,</span> key<span class="token punctuation">,</span> keys<span class="token punctuation">)</span> <span class="token keyword">do</span>
  update_in<span class="token punctuation">(</span>opts<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">fn</span> value <span class="token operator">-></span> Keyword<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>Keyword<span class="token punctuation">.</span>take<span class="token punctuation">(</span>opts<span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>

<span class="token keyword">defp</span> carry_over_many<span class="token punctuation">(</span>opts<span class="token punctuation">,</span> key<span class="token punctuation">,</span> keys<span class="token punctuation">)</span> <span class="token keyword">do</span>
  update_in<span class="token punctuation">(</span>opts<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">fn</span> list <span class="token operator">-></span>
    defaults <span class="token operator">=</span> Keyword<span class="token punctuation">.</span>take<span class="token punctuation">(</span>opts<span class="token punctuation">,</span> keys<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>k<span class="token punctuation">,</span> v<span class="token punctuation">}</span> <span class="token operator">&lt;-</span> list<span class="token punctuation">,</span> <span class="token attr-name">do:</span> <span class="token punctuation">{</span>k<span class="token punctuation">,</span> Keyword<span class="token punctuation">.</span>merge<span class="token punctuation">(</span>defaults<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token keyword">end</span><span class="token punctuation">)</span>
<span class="token keyword">end</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h1 id="closing-the-curtains" style="position:relative;"><a href="#closing-the-curtains" aria-label="closing the curtains permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Closing the curtains</h1>
<p>To conclude, Broadway is a powerful library for building data processing pipelines. These pipelines are built on top of the robust concurrency system that Elixir boasts.</p>
<p>Broadway is a very versatile library and the documentation contains detailed guides about using it with various data sources. Check out the <a href="https://github.com/dashbitco/broadway">Github repository</a> and <a href="https://hexdocs.pm/broadway/Broadway.html#content">documentation!</a></p>
<hr>
<p>If you want to get a basic understanding of the underlying concepts of Broadway or better visualise the architecture of a pipeline in Broadway, check out the first part <a href="open-source-deep-dive-broadway-part-1">here!</a></p>
<hr>
<p>Open-source Deep Dive is a series where I pick apart open-source projects to explain the underlying concepts that power these projects and share my findings about the project!</p></div></div><p><hr/><a href="/rss.xml">Subscribe</a> to the blog&#x27;s RSS feed to get updates of the latest blog posts!</p><div class="PostNavigation-module--navigation--1UueV"><hr/><div class="PostNavigation-module--buttons--36jEH"><p><a href="/blog/posts/web-development-is-frustrating"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" style="margin-right:15px" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M217.9 256L345 129c9.4-9.4 9.4-24.6 0-33.9-9.4-9.4-24.6-9.3-34 0L167 239c-9.1 9.1-9.3 23.7-.7 33.1L310.9 417c4.7 4.7 10.9 7 17 7s12.3-2.3 17-7c9.4-9.4 9.4-24.6 0-33.9L217.9 256z"></path></svg>Web Development is Frustrating</a></p><p><a href="/blog/posts/open-source-deep-dive-broadway-part-1">Open-source Deep Dive: Broadway (Part 1) - Message queues, concurrency in Elixir, and Broadway architecture<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" style="margin-left:15px" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M294.1 256L167 129c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.3 34 0L345 239c9.1 9.1 9.3 23.7.7 33.1L201.1 417c-4.7 4.7-10.9 7-17 7s-12.3-2.3-17-7c-9.4-9.4-9.4-24.6 0-33.9l127-127.1z"></path></svg></a></p></div></div></div><footer><div><div class="Layout-module--site-description--1flSc"><p class="Layout-module--footer-title--17YbO">A Programmer&#x27;s Perspective</p><br/><p>Trekking down the path of programming and discussing my encounters with the unknown!</p><br/><p>Copyright © 2020-2021. Code <a href="https://github.com/woojiahao/woojiahao.github.io">here.</a></p></div><div class="Layout-module--footer-links--3kCkY"><div class="Layout-module--page-navigation--1a6eH"><p class="Layout-module--footer-title--17YbO">Navigation</p><a href="/">Home</a><a href="/blog">Blog</a><a href="/projects">Projects</a><a href="/about">About Me</a><a href="https://www.notion.so/woojiahao/48b21a97d71c4cd2bc9a9051bd7423a3?v=e2c493015ceb47cfa275a03f20895cb1">Recommendations</a></div><div class="Layout-module--social-media--293qT"><p class="Layout-module--footer-title--17YbO">Connect with me!</p><a target="_blank" href="https://github.com/woojiahao"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg>woojiahao</a><a target="_blank" href="https://discord.gg/programming"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M20.222 0c1.406 0 2.54 1.137 2.607 2.475V24l-2.677-2.273-1.47-1.338-1.604-1.398.67 2.205H3.71c-1.402 0-2.54-1.065-2.54-2.476V2.48C1.17 1.142 2.31.003 3.715.003h16.5L20.222 0zm-6.118 5.683h-.03l-.202.2c2.073.6 3.076 1.537 3.076 1.537-1.336-.668-2.54-1.002-3.744-1.137-.87-.135-1.74-.064-2.475 0h-.2c-.47 0-1.47.2-2.81.735-.467.203-.735.336-.735.336s1.002-1.002 3.21-1.537l-.135-.135s-1.672-.064-3.477 1.27c0 0-1.805 3.144-1.805 7.02 0 0 1 1.74 3.743 1.806 0 0 .4-.533.805-1.002-1.54-.468-2.14-1.404-2.14-1.404s.134.066.335.2h.06c.03 0 .044.015.06.03v.006c.016.016.03.03.06.03.33.136.66.27.93.4.466.202 1.065.403 1.8.536.93.135 1.996.2 3.21 0 .6-.135 1.2-.267 1.8-.535.39-.2.87-.4 1.397-.737 0 0-.6.936-2.205 1.404.33.466.795 1 .795 1 2.744-.06 3.81-1.8 3.87-1.726 0-3.87-1.815-7.02-1.815-7.02-1.635-1.214-3.165-1.26-3.435-1.26l.056-.02zm.168 4.413c.703 0 1.27.6 1.27 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334.002-.74.573-1.338 1.27-1.338zm-4.543 0c.7 0 1.266.6 1.266 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334 0-.74.57-1.338 1.27-1.338z"></path></svg>@Chill#4048</a><a target="_blank" href="https://www.linkedin.com/in/jia-hao-woo-089346155/"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM349.3 793.7H230.6V411.9h118.7v381.8zm-59.3-434a68.8 68.8 0 1 1 68.8-68.8c-.1 38-30.9 68.8-68.8 68.8zm503.7 434H675.1V608c0-44.3-.8-101.2-61.7-101.2-61.7 0-71.2 48.2-71.2 98v188.9H423.7V411.9h113.8v52.2h1.6c15.8-30 54.5-61.7 112.3-61.7 120.2 0 142.3 79.1 142.3 181.9v209.4z"></path></svg>Woo Jia Hao</a><a target="_blank" href="https://twitter.com/woojiahao_"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM727.3 401.7c.3 4.7.3 9.6.3 14.4 0 146.8-111.8 315.9-316.1 315.9-63 0-121.4-18.3-170.6-49.8 9 1 17.6 1.4 26.8 1.4 52 0 99.8-17.6 137.9-47.4-48.8-1-89.8-33-103.8-77 17.1 2.5 32.5 2.5 50.1-2a111 111 0 0 1-88.9-109v-1.4c14.7 8.3 32 13.4 50.1 14.1a111.13 111.13 0 0 1-49.5-92.4c0-20.7 5.4-39.6 15.1-56a315.28 315.28 0 0 0 229 116.1C492 353.1 548.4 292 616.2 292c32 0 60.8 13.4 81.1 35 25.1-4.7 49.1-14.1 70.5-26.7-8.3 25.7-25.7 47.4-48.8 61.1 22.4-2.4 44-8.6 64-17.3-15.1 22.2-34 41.9-55.7 57.6z"></path></svg>@woojiahao_</a><a target="_blank" href="mailto: woojiahao1234@gmail.com"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"></path></svg>woojiahao1234@gmail.com</a><a href="/rss.xml"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"></path></svg><span>Blog RSS feed</span></a></div></div></div></footer></div><div class="BackToTop-module--hidden--Gjp_L BackToTop-module--arrow--al5Ui"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1.75em" width="1.75em" xmlns="http://www.w3.org/2000/svg"><path d="M868 545.5L536.1 163a31.96 31.96 0 0 0-48.3 0L156 545.5a7.97 7.97 0 0 0 6 13.2h81c4.6 0 9-2 12.1-5.5L474 300.9V864c0 4.4 3.6 8 8 8h60c4.4 0 8-3.6 8-8V300.9l218.9 252.3c3 3.5 7.4 5.5 12.1 5.5h81c6.8 0 10.5-8 6-13.2z"></path></svg></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-164563111-1"></script><script>
      
      function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-164563111-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-164563111-1', {"anonymize_ip":true,"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/posts/open-source-deep-dive-broadway-part-2";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-659f323bb909e9bc151d.js"],"app":["/app-4a9d307f2885b4f64f6e.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-efe50ecdf8a80eae52cf.js"],"component---src-pages-404-js":["/component---src-pages-404-js-656c18c0a2285648bec9.js"],"component---src-pages-index-js":["/component---src-pages-index-js-57385845808895fde079.js"],"component---src-templates-blog-list-blog-list-js":["/component---src-templates-blog-list-blog-list-js-3d1b3a4a9bf33072d7d7.js"],"component---src-templates-blog-post-blog-post-js":["/component---src-templates-blog-post-blog-post-js-f267812a355f85283a5c.js"],"component---src-templates-general-post-js":["/component---src-templates-general-post-js-eec9ce006001cb6ac0c2.js"],"component---src-templates-project-list-project-list-js":["/component---src-templates-project-list-project-list-js-3f74528e2a199a06f4d8.js"],"component---src-templates-project-listing-project-listing-js":["/component---src-templates-project-listing-project-listing-js-24efa95f36b5d63fb0c7.js"],"component---src-templates-redirect-page-js":["/component---src-templates-redirect-page-js-17042f58101c641ba621.js"]};/*]]>*/</script><script src="/polyfill-659f323bb909e9bc151d.js" nomodule=""></script><script src="/component---src-templates-blog-post-blog-post-js-f267812a355f85283a5c.js" async=""></script><script src="/9f543f25a70c8f21fd0b844d715a43e0aaffa939-4470a7232cdc07660afe.js" async=""></script><script src="/5e2a4920-d58c882e2d65d1e647e3.js" async=""></script><script src="/95b64a6e-e6f59033fe861f7df6b7.js" async=""></script><script src="/252f366e-0874e02fa63f9a6c7f8a.js" async=""></script><script src="/0c428ae2-0daca1561ab49c58bacf.js" async=""></script><script src="/d7eeaac4-197509e568d5f7b31992.js" async=""></script><script src="/1bfc9850-f060242a6c1c3ec3bbdf.js" async=""></script><script src="/d0447323-dbe848dbbde40afbc849.js" async=""></script><script src="/app-4a9d307f2885b4f64f6e.js" async=""></script><script src="/framework-7ff507bf526aae82f6c3.js" async=""></script><script src="/webpack-runtime-9d6d8fbb38c670d0db17.js" async=""></script></body></html>