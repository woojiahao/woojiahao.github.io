{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/posts/2020-04-14-Gatsby.js + GitHub Actions + GitHub Pages = Match Made in Heaven","result":{"data":{"markdownRemark":{"html":"<p>After a long hiatus induced by the demons that was school, I have finally defeated the final boss and graduated! </p>\n<p>With that, I have started to work on re-building my portfolio site (you're seeing it right now!). I wanted to learn <a href=\"https://www.gatsbyjs.org/\">Gatsby.js</a> and so I figured it would be the best time to do so! While working with Gatsby.js, one of the issues that I had faced was not having a proper guide on deploying Gatsby.js applications onto GitHub Pages via GitHub Actions. The official documentation does include a <a href=\"https://www.gatsbyjs.org/docs/how-gatsby-works-with-github-pages/\">guide</a> on perform <a href=\"https://www.atlassian.com/continuous-delivery/continuous-deployment\">Continuous Deployment (CD)</a> via <a href=\"https://travis-ci.org/\">Travis.CI</a> but I wanted to mess around with <a href=\"https://github.com/features/actions\">GitHub Actions</a> - GitHub's own CI/CD pipeline.</p>\n<p>So I decided to experiment with building my own workflow and document my process. It was quite interesting how I got to the current refinement of my CD workflow and I will be sharing a little on the mistakes that I had made and the lessons learnt.</p>\n<h2>Why Gatsby.js?</h2>\n<p>Taken directly from Gatsby's web description...</p>\n<blockquote>\n<p>Gatsby.js is a PWA (Progressive Web App) generator.</p>\n</blockquote>\n<p>It may seem a little odd at first but basically, Gatsby.js is a static site generator built around React. It ties together various React plugins - like <code class=\"language-text\">react-router</code> and <code class=\"language-text\">webpack</code> - to create a seamless development experience when creating static sites.</p>\n<p>A static site is a site where a framework is used but the library generates the resulting HTML/CSS/JS files. In doing so, the site is far more performant than dynamic sites that take time to execute the code of the framework. Gatsby.js performs all the execution when creating a bundle and we simply deploy this bundle to GitHub pages or any web hosting platform to have our site up and running. </p>\n<p>In a future post, I will be covering the merits of a static site generator - specifically Gatsby.js - but for now, let's move on to our next tool, <strong>GitHub Pages!</strong></p>\n<h2>Why GitHub Pages?</h2>\n<p>GitHub pages is...</p>\n<blockquote>\n<p>GitHub Pages is a static site hosting service that takes HTML, CSS, and JavaScript files straight from a repository on GitHub, optionally runs the files through a build process, and publishes a website.</p>\n</blockquote>\n<p>(Definition taken from <a href=\"https://help.github.com/en/github/working-with-github-pages/about-github-pages\">here</a>)</p>\n<p>I would like to focus on these four hyper-critical words: \"static site hosting service\". Recall when I mentioned that Gatsby.js is a static site generator? These four words are like music to my ears! It means that once we have generated that bundle with Gatsby.js, we can use GitHub Pages to host our website! </p>\n<p>This is awesome because I needed a cheap (if not nothing) hosting provider to host my portfolio website. GitHub Pages will deploy the site directly from a GitHub repository, providing seamless integration and it is super userful for creating documentation sites for your projects!</p>\n<p>A big perk to using GitHub Pages is that you can have a <strong>user page</strong>. This is created from a repository that follows this naming pattern: <code class=\"language-text\">&lt;GitHub username&gt;.github.io</code>. When using a user page, you will receive access to the <code class=\"language-text\">.github.io</code> domain. This is useful for portfolio sites as it now means that we are able to deploy our portfolio page and have a domain name like <code class=\"language-text\">woojiahao.github.io</code>! </p>\n<p>You can find out more about GitHub pages <a href=\"https://help.github.com/en/github/working-with-github-pages/about-github-pages\">here</a> and more about user pages <a href=\"https://help.github.com/en/github/working-with-github-pages/about-github-pages#types-of-github-pages-sites\">here.</a></p>\n<h2>Why GitHub Actions?</h2>\n<p>Finally, we have the star of the evening - <strong>GitHub Actions!</strong></p>\n<blockquote>\n<p>GitHub Actions makes it easy to automate all your software workflows, now with world-class CI/CD. Build, test, and deploy your code right from GitHub.</p>\n</blockquote>\n<p>(Definition taken from <a href=\"https://github.com/features/actions\">here</a>)</p>\n<p>GitHub Actions allows us to develop CI/CD workflows that integrates directly with GitHub. For our use case, we can use the default tier. </p>\n<p>I picked GitHub Actions primarily because I was intrigued by it and wanted to give it a spin. I had adopted it when working on <a href=\"/projects/posts/torrent.go\"><strong>torrent.go</strong></a> (a BitTorrent protocol implementation written with Go!) and found that it was rather unique in its approach so I wanted to test it out even more.</p>\n<h2>Chief! What is our plan of attack?</h2>\n<p>First, I would like to discuss the final strategy that I took to deploy my portfolio site to GitHub pages.</p>\n<p>To begin, we need to outline the strict limitation of user sites...</p>\n<blockquote>\n<p>If the repository for your user or organization site has a master branch, your site will publish automatically from that branch. You cannot choose a different publishing source for user or organization sites.</p>\n</blockquote>\n<p>This means that for our site, if we are using <code class=\"language-text\">woojiahao.github.io</code>, we MUST publish the site to the <code class=\"language-text\">master</code> branch.</p>\n<p>Our CD workflow looks a little like this:</p>\n<ol>\n<li>\n<p>We push our latest changes in Gatsby.js (including new blog posts, project listings, or just site changes) to a <code class=\"language-text\">develop</code> branch</p>\n<p>As we may have multiple sets of changes that we push at different times, we do not want our site to be deployed immediately. Instead, we move on to step dos!</p>\n</li>\n<li>We will merge the changes into a <code class=\"language-text\">publish</code> branch. On merge, we should automatically deploy our application.</li>\n<li>Now this is where it gets tricky, we need to build our Gatsby.js page - to create the bundle - and set the contents of this bundle to the contents of the <code class=\"language-text\">master</code> branch.</li>\n</ol>\n<p>  This is where you can see our consideration of the limitation mentioned above take effect. However, by setting the <code class=\"language-text\">master</code> branch to be a \"dump\" for the bundle files, it would be hard for us to navigate our GitHub repository. This is why we need to properly setup our branches to allow for this peculiar workflow!</p>\n<h2>Go, go, go!</h2>\n<p>Let's dive right into the configurations.</p>\n<h3>Setting up branching</h3>\n<p>The first order of business is to properly setup our branching strategy. We will use a mix of both the GitHub UI and the Git CLI. So if you have not installed the Git CLI, you can do so <a href=\"https://git-scm.com/book/en/v2/Getting-Started-Installing-Git\">here.</a></p>\n<p>As mentioned in our workflow, we will be using three branches:</p>\n<ul>\n<li><code class=\"language-text\">master</code> - to hold the build bundle and renders the page</li>\n<li><code class=\"language-text\">develop</code> - pseudo-master branch that we will use to host our changes in Gatsby.js</li>\n<li><code class=\"language-text\">publish</code> - merge-only branch that we use to trigger a deployment</li>\n</ul>\n<p>So, let's first create and push the other two branches.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\">$ <span class=\"token function\">git</span> checkout -b develop\n$ <span class=\"token function\">git</span> checkout -b publish\n$ <span class=\"token function\">git</span> push -u origin develop\n$ <span class=\"token function\">git</span> push origin publish</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>So we checkout the <code class=\"language-text\">develop</code> branch before the <code class=\"language-text\">publish</code> branch since we want the <code class=\"language-text\">publish</code> branch to be based on the latest changes of the <code class=\"language-text\">develop</code> branch. Don't worry, however, we will only be needing to checkout the <code class=\"language-text\">publish</code> branch via the Git CLI only once to configure.</p>\n<p>We push and set the <code class=\"language-text\">develop</code> branch to be our <a href=\"https://stackoverflow.com/questions/4693588/what-is-a-tracking-branch\">tracking branch</a> as from now on, we want to permanently push to the remote <code class=\"language-text\">develop</code> branch.</p>\n<p>We also push the <code class=\"language-text\">publish</code> branch to create the remote branch.</p>\n<p>If you go to the repository in GitHub and expand the \"Branch\" dropdown, you should see that there will be three branches now.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 333px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d898b368ad862ca9f36e76284c27b35/24c7e/remote-branches.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACIklEQVQ4y42T6W6bUBCF76PUYbkbdwPMYswOcZPYJn/apu//Ij1gKUpTqwr6GI0szp3xmblE27iqm/xQFYfjMM7jfBqneZ8XTETJPpumqayO/dA3bdd2fdf3SpuA8pCtEIjrrq+aFuKnl/PLZTlfLuWh4lJlRXFdlvn0/fnpaX48XV+X55dn4xxklAtARKSBVCbSjglFuURNERllHBcqCFFBBFQg+iFHIqQSUgMZGcK4fJynXz9/nFH1cl6W6/V6eX1dfr+9jcNAKZNCCjwc75pwvgGZVESqmJlcuHKNtgAc0ZXSlcipzrjJ7yJNRmjciWziSc2SmsZHnjSAOiQ1T9fcN+UddB6kM2HpkBWHfWqTxFmr9qnb72NrFGKWJUlihWBhGPxNGPq7wLWE24Nnu52qdrreqaNnGt+1nm2/RdWDrj3bBK77F991NO6JjLQydpjmBkMcJ+MSypWL03GctIX/ETz/yObz5rbUMMxgbmmWuziJ0xTTYzxS2h2bVm/Tug3mnZDeZoY9sARKaIyLsRjVsc7LMqAMPPhBQGnI2Efwez8M58sZkQlJqIhsnKBD2FYcqqwocehtVW7JJw4Vtngsq3UFCV4/pOgWS4sjkLxv3128gO684AGty4igAr5GD3XT4EhtrU/Zbe/vspoiBN0ka2Xo1yaFZDJaEV9B4kagskTbiLh9p9NjnKReSG+e/Yftn0oilOGR5tvFElvyRSD8A75hvgCmskWeAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GitHub remote branches\"\n        title=\"GitHub remote branches\"\n        src=\"/static/1d898b368ad862ca9f36e76284c27b35/24c7e/remote-branches.png\"\n        srcset=\"/static/1d898b368ad862ca9f36e76284c27b35/3684f/remote-branches.png 225w,\n/static/1d898b368ad862ca9f36e76284c27b35/24c7e/remote-branches.png 333w\"\n        sizes=\"(max-width: 333px) 100vw, 333px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Once done, we can now continue our branching configurations in the GitHub UI.</p>\n<p>Under \"Settings > Branches\", there is an option for the \"Default branch\". Normally, it is the <code class=\"language-text\">master</code> branch. However, as mentioned earlier, we want to be able to view and access our repository easily (and have the all-so-important language colors be right!). So, we will change the default branch to be <code class=\"language-text\">develop</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aef20a3af94b6a331fae5554dd438b30/b6e34/default-branch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAwklEQVQY002PC47DIAxEOUwLGPOzE0hoAv3k/ndas6pWKz2N8AiPbRViTJlEY8zEC6IPMYXpcc4kBTGLZubC9D5qCt5YZ2GiwAdwHjAYQF5rexxbe5S6afnhcCqghu9bO7xbuJuJlApoNxj1rxVSXkvlUmQOoJeGP5V05ycYovNCEF9R2WekddK8lPq5rnOM9+fqz+fRex/jFHm9zj54XTMvtHyRRIVU5AbZWfpl8t5aIt5aM+D+I6vdtLkZM3VixfkBUOY2PJtR8oYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GitHub changing default branches\"\n        title=\"GitHub changing default branches\"\n        src=\"/static/aef20a3af94b6a331fae5554dd438b30/1cfc2/default-branch.png\"\n        srcset=\"/static/aef20a3af94b6a331fae5554dd438b30/3684f/default-branch.png 225w,\n/static/aef20a3af94b6a331fae5554dd438b30/fc2a6/default-branch.png 450w,\n/static/aef20a3af94b6a331fae5554dd438b30/1cfc2/default-branch.png 900w,\n/static/aef20a3af94b6a331fae5554dd438b30/b6e34/default-branch.png 1103w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Once we have configured these two aspects, we are done with our branching strategy! Let's move on to the real meat of this CD - the workflow!</p>\n<h3>Creating the workflow</h3>\n<p>GitHub Actions will look out for <strong>workflows</strong> in our repository to determine what actions are to be run. These workflows are stored in the <code class=\"language-text\">.github/workflows</code> folder.</p>\n<p>We can just name our CD workflow as <code class=\"language-text\">deploy.yml</code>. Yes, these workflow files are declared as YAML documents - like Docker Compose!</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">/\n|_.github/\n  |_workflows/\n    |_deploy.yml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Then, we can start to configure our workflow. Fire up your favourite text editor and let's begin!</p>\n<p>The first thing we will configure is when this workflow will run. As mentioned earlier, we want to deploy our site only when we push to the <code class=\"language-text\">publish</code> branch via a merge, thus, we will have the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span> \n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> publish</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Then, we can start declaring our jobs aka the thing that runs. GitHub Actions allows us to configure concurrent jobs or jobs that rely on one another, but I will not be going into detail about those in this post. If you want more information, please refer to the documentation <a href=\"https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobs\">here.</a> </p>\n<p>This workflow will only require one job and we can call it <code class=\"language-text\">deploy</code>. </p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span> \n  deploy<span class=\"token punctuation\">:</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>We then specify what is the underlying OS the CD will use to execute this workflow.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Then we declare strategies. From my understanding, these are variables that we can use and we can declare them as arrays to allow us to execute the workflow on multiple versions of Node for instance.</p>\n<p>However, in our case, we can make do with just having one version of Node since we are building once. If you require more details about strategies in GitHub Actions, refer <a href=\"https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idstrategy\">here.</a></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">    <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node_version</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>13.x<span class=\"token punctuation\">]</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Finally, we can declare our steps for the workflow.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">    steps<span class=\"token punctuation\">:</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>First, checkout the repository so that our workflow can access it.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">...</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Then, we setup Node in out Ubuntu machine. We use the <code class=\"language-text\">node_version</code> we declared in our strategy.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">...</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.node_version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Then, we install <code class=\"language-text\">gatsby-cli</code> and the necessary dependencies for our static site to be generated.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">...</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install <span class=\"token punctuation\">-</span>g gatsby<span class=\"token punctuation\">-</span>cli <span class=\"token important\">&amp;&amp;</span> npm install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>optional</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Then, we set the Git credentials as we are using the <code class=\"language-text\">gh-pages</code> npm package to deploy our site. I will explain further later on.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">...</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> git config <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global user.email \"&lt;insert GitHub email\" <span class=\"token important\">&amp;&amp;</span> git config <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global user.name \"&lt;insert desired name<span class=\"token punctuation\">></span>\"</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Lastly, we can build the site bundle and deploy it. I have used a custom script declared in the <code class=\"language-text\">package.json</code> and a GitHub token, both of which I will be discussing below.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\">      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">...</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run deploy\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span> <span class=\"token key atrule\">GH_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GH_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>There it is. We have created the workflow for deploying our application. However, we have some missing components that we have yet to configure so buckle up for our last set of configurations.</p>\n<p>A sample of the whole workflow file looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span> \n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> publish\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy website to Github Pages with Gatsby\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">strategy</span><span class=\"token punctuation\">:</span> \n      <span class=\"token key atrule\">matrix</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">node_version</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>13.x<span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setup Node.js version $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.node_version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v1\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> matrix.node_version <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Installing Gatsby CLI\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install <span class=\"token punctuation\">-</span>g gatsby<span class=\"token punctuation\">-</span>cli <span class=\"token important\">&amp;&amp;</span> npm install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>optional\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Setting Git credentials\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> git config <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global user.email \"woojiahao1234@gmail.com\" <span class=\"token important\">&amp;&amp;</span> git config <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>global user.name \"woojiahao\"\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy the site\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run deploy\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span> \n          <span class=\"token key atrule\">GH_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GH_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h3>Creating a deploy script</h3>\n<p>We are using the <code class=\"language-text\">gh-pages</code> to automatically push the build bundle to the <code class=\"language-text\">master</code> branch. We will need to setup a <code class=\"language-text\">deploy</code> script in our <code class=\"language-text\">package.json</code> to use this package. This script will build the bundle and deploy it to the <code class=\"language-text\">master</code> branch.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-json line-numbers\"><code class=\"language-json\">  <span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    ...<span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"deploy\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"gatsby build &amp;&amp; gh-pages -d public -b master -r https://$GH_TOKEN@github.com/woojiahao/woojiahao.github.io.git\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>I would like to focus in on the command for <code class=\"language-text\">gh-pages</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-text line-numbers\"><code class=\"language-text\">gh-pages -d public -b master -r ...</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p><code class=\"language-text\">-d</code> indicates which folder the build bundle is located. In Gatsby.js case, it is the <code class=\"language-text\">public/</code> folder.</p>\n<p><code class=\"language-text\">-b</code> indicates which branch we will push the build bundle to. By default, it is the <code class=\"language-text\">gh-pages</code> branch. But as I have explained, we need it to be the <code class=\"language-text\">master</code> branch.</p>\n<p><code class=\"language-text\">-r</code> indicates the GitHub repsitory we will be pushing too. This uses the <code class=\"language-text\">GH_TOKEN</code> environment variable that we have loaded into the workflow. It also leads us nicely to the next and final configuration we need to perform - getting a GitHub access token.</p>\n<h3>Shhh! ... (Access tokens and secrets)</h3>\n<p>The last ingredient to this workflow recipe is a GitHub access token.</p>\n<p>We can generate a personal access token under \"Settings > Developer settings > Personal access tokens > Generate new token\". </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3ea1db94d0f2eda55742021ae75f6a1d/99661/access-token-location.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAoUlEQVQI1z2OAQoDMQgE7zG9UxOTaKJJSin9/69qWygMosu6emDtpZv5NPfEfLswOCEqnEBA6cI/9NNv8DEEB3BDsZNyDEBZh/naYy5f99LkG0TXD6RQ1t7dXKuM2g5Wk/uLmyYusdzH8PjDfc4ZvfShfdRuJA4pAybKjCkjfTi6ahwZvmTYhZjVeb/KevJ8FNtN5OtmCCjVJk21idZShesb3T8qqW6evJgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GitHub access token settings location\"\n        title=\"GitHub access token settings location\"\n        src=\"/static/3ea1db94d0f2eda55742021ae75f6a1d/1cfc2/access-token-location.png\"\n        srcset=\"/static/3ea1db94d0f2eda55742021ae75f6a1d/3684f/access-token-location.png 225w,\n/static/3ea1db94d0f2eda55742021ae75f6a1d/fc2a6/access-token-location.png 450w,\n/static/3ea1db94d0f2eda55742021ae75f6a1d/1cfc2/access-token-location.png 900w,\n/static/3ea1db94d0f2eda55742021ae75f6a1d/99661/access-token-location.png 1098w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>When generating the token, restrict the token's scope to <code class=\"language-text\">repo</code> only. </p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 834px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dcccc63c1b15c03cb402588462924199/5d72a/create-token.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABi0lEQVQoz22S2W7UQBBF/S0QL+12L+7NvdkzQxDhg3jhjX/hAc0Dm4g0SSQCPCAB4qO47pHISBPpuKQZVfnWveVKjMpMk7YOKGNRjbXGOS4k46JUPjBGGRuEGPgDXU8rZUzKOcToQ0g52Zhl3I5hASouKm2lX9z2SoesjcHblTZHmX4YqmX3bLO7dD5OIfuYpzjbkK1PNqRSs/GpIbRuu4umPaVuSfXq9ZvPhx9v91/2n273H2/evT9c3/28/fbn5v734euvu+9/P1zfwxq6W9K3hBT6piOgwq4vrl7uLp9bH6S2o3HKIoIJtg38u0kb27TdShk4BZ5hM/kY6JoKsuF0YB0dnhL2pHBBBRGmpex8voL7PC9SKTkq1FFrj/Bi0j4rn02cqXIY7ig/LnxKxbi0k8eGkC0xdNjTTd6HSSmFI8Fs3TTnsuswHvTOm01eZlwPP52HcDlejGiq19b+3PA6jFtDCt1cyhIphTBuXsQRBK8fi+phmAz4eiShQ9tTcEyOMkG5+P/no/wDW1WMBdwj//EAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GitHub create token\"\n        title=\"GitHub create token\"\n        src=\"/static/dcccc63c1b15c03cb402588462924199/5d72a/create-token.png\"\n        srcset=\"/static/dcccc63c1b15c03cb402588462924199/3684f/create-token.png 225w,\n/static/dcccc63c1b15c03cb402588462924199/fc2a6/create-token.png 450w,\n/static/dcccc63c1b15c03cb402588462924199/5d72a/create-token.png 834w\"\n        sizes=\"(max-width: 834px) 100vw, 834px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You will receive a token once you create it. Copy this token to your clipboard and save it somewhere secure.</p>\n<p>Then, go to the Gatsby.js repository and under \"Settings > Secrets\", select \"Add a new secret\". The name of the secret must be <code class=\"language-text\">GH_TOKEN</code> and the value is the copied token.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 900px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/eb2bc7b2a74edbd2a5804a25ba296441/25260/add-secret.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABFElEQVQoz42RW47DIAxFs5gUvyGEkESddqq+9r+lMaRf8zEa6ejKMhjblyGm5KQ0idpcFjWzmKYpp45anPJsXfc6X7eiIoCM1Bg4TsRCYkiScl633VICP2NxPkFXIAkOkgPkeHG9oOWA7Cm2WLdd46fYlViPMgdZSRqsBv2VgZcvYPXiESiX5fV+3+535/F8uN6fT89831qwn89z3fKy+jUWDYCDrFfoTYJPH1PpZ778vFTH41Jqz1Rfm2OGOJ+8E6L362NrhLYG+yucIyiPAcaAI+AJ8AhcPQ7YIV7ipGLe+QZsRzGKSdm47KjJLe2r/tIP1O0cbL1QXkNf+zCmWdD84D84Nc95yHULpNDwn+A+GP2THz9lXdZ0kYqaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"GitHub add secret\"\n        title=\"GitHub add secret\"\n        src=\"/static/eb2bc7b2a74edbd2a5804a25ba296441/1cfc2/add-secret.png\"\n        srcset=\"/static/eb2bc7b2a74edbd2a5804a25ba296441/3684f/add-secret.png 225w,\n/static/eb2bc7b2a74edbd2a5804a25ba296441/fc2a6/add-secret.png 450w,\n/static/eb2bc7b2a74edbd2a5804a25ba296441/1cfc2/add-secret.png 900w,\n/static/eb2bc7b2a74edbd2a5804a25ba296441/25260/add-secret.png 1113w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>For more information about personal access tokens and GitHub secrets in GitHub Actions, you can check these links out: <a href=\"Ben2020#2762\">access tokens</a> and <a href=\"https://help.github.com/en/actions/configuring-and-managing-workflows/using-variables-and-secrets-in-a-workflow\">secrets.</a></p>\n<p>And we are done! This was all the configuration we needed to get the CD workflow working!</p>\n<h3>IT WORKS!!</h3>\n<p>We can test whether the workflow works by making a merge request from <code class=\"language-text\">develop</code> to <code class=\"language-text\">publish</code>. When we accept the merge request, it will push the changes to the <code class=\"language-text\">publish</code> branch and in turn, trigger the workflow and deploy our site.</p>\n<p>Now, just sit back and enjoy as the deployment happens automatically.</p>\n<h2>Mistakes were made...</h2>\n<p>While experimenting with GitHub Actions, I had several \"duh\" moments.</p>\n<h3>YAML disaster</h3>\n<p>When I was writing the first iteration of the workflow file, I failed to read the documentation for GitHub secrets and had incorrectly set the environment variable.</p>\n<p>FYI, environment variables should be declared like this</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">&lt;key></span><span class=\"token punctuation\">:</span> &lt;value<span class=\"token punctuation\">></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>and not like this</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-yaml line-numbers\"><code class=\"language-yaml\"><span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.GH_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Because I had declared it improperly, I was not able to access the <code class=\"language-text\">GH_TOKEN</code> token in my workflow and it caused the workflow to fail. It took me a while to realise what I had done.</p>\n<h3>Repository takeover!</h3>\n<p>When I was first designing my workflow, I had actually completely forgotten that there were branches outside of <code class=\"language-text\">developer</code> and <code class=\"language-text\">master</code>. Originally, I had created a completely separate repository to house my development code. This left the original repository to be a hosting platform for the build bundle.</p>\n<p>It took me a while to realise how impractical and unnecessary this was and I re-designed the workflow.</p>\n<h2>Conclusion</h2>\n<p>Overall, this was an interesting journey! I learnt a fair bit about Gatsby.js and GitHub Actions along the way. If you wish to view the Gatsby.js project I use for my portfolio site, you can visit it <a href=\"https://github.com/woojiahao/woojiahao.github.io\">here</a></p>","frontmatter":{"title":"Gatsby.js + GitHub Actions + GitHub Pages = Match Made in Heaven?","date":"14 April 2020","description":"A deep dive into creating an continuous deployment system using Gatsby.js, GitHub Actions, and GitHub Pages"},"fields":{"slug":"/blog/posts/2020-04-14-Gatsby.js + GitHub Actions + GitHub Pages = Match Made in Heaven"}},"allMarkdownRemark":{"edges":[{"node":{"fields":{"slug":"/blog/posts/2019-09-06-Lessons from Meetup"},"frontmatter":{"title":"Lessons from Meetup (and Docker)","published":true}}},{"node":{"fields":{"slug":"/blog/posts/2020-04-21-Deploying a Discord bot written with Kotlin on Heroku"},"frontmatter":{"title":"Deploying discord bots written in Kotlin to Heroku","published":true}}}]}},"pageContext":{"slug":"/blog/posts/2020-04-14-Gatsby.js + GitHub Actions + GitHub Pages = Match Made in Heaven","next":"/blog/posts/2020-04-21-Deploying a Discord bot written with Kotlin on Heroku","prev":"/blog/posts/2019-09-06-Lessons from Meetup"}}}